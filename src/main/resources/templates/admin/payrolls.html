<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>All Payroll</title>
<th:block th:replace="admin/fragments :: css"></th:block>
<th:block th:replace="admin/fragments :: scripts"></th:block>
</head>
<body>

	<th:block th:insert="admin/admin-dashboard :: logo"></th:block>
	<th:block th:insert="admin/admin-dashboard :: sidebar"></th:block>
	<div class="br-header">
		<div class="br-header-left">
			<div class="navicon-left hidden-md-down">
				<a id="btnLeftMenu" href="#"><i class="icon ion-navicon-round"></i></a>
			</div>
			<div class="navicon-left hidden-lg-up">
				<a id="btnLeftMenuMobile" href="#"><i
					class="icon ion-navicon-round"></i></a>
			</div>
			<div class="br-pagetitle pt-0 justify-content-space-around">

				<div class="signin-logo tx-center tx-28 tx-bold tx-inverse">
					<span class="tx-normal"></span> All <span class="tx-info">Payrolls</span>
					<span class="tx-normal"></span>
				</div>



			</div>

		</div>
		<th:block th:insert="admin/admin-dashboard :: header"></th:block>
	</div>
	<div class="br-mainpanel">
		<div class="br-pageheader bg-0 mb-0">
			<nav class="breadcrumb pd-0 mg-0 tx-12">
				<a class="breadcrumb-item" th:href="@{/admin/dashboard}">Dashboard</a>
				<a class="breadcrumb-item" th:href="@{/admin/payroll}">Payroll</a>


			</nav>

		</div>


		<div class="br-pagebody ">	
		 <div class="row mb-4">
		  <div class="col-md-4 mb-3">
                    <div class="bg-info rounded overflow-hidden">
                        <div class="pd-x-20 pd-t-20 d-flex align-items-center ">
                            <i class="ion ion-earth tx-60 lh-0 tx-white op-7"></i>
                            <div class="mg-x-20">
                                <p class="tx-10 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10">
                                    Total Employee</p>
                                <p class="tx-24 tx-white tx-lato tx-bold mg-b-0 lh-1" th:text="${session.countEmployee}"></p>
                                <span class="tx-11 tx-roboto tx-white-8"></span>
                            </div>
                        </div>
                        <div id="ch1" class="ht-50 tr-y-1"></div>
                    </div>
                </div>
               <div class="col-md-4 mb-3">
                    <div class="bg-info rounded overflow-hidden">
                        <div class="pd-x-20 pd-t-20 d-flex align-items-center">
                            <i class="ion ion-earth tx-60 lh-0 tx-white op-7"></i>
                            <div class="mg-l-20">
                                <p class="tx-10 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10">
                                    Total Allowance</p>
                                <p class="tx-24 tx-white tx-lato tx-bold mg-b-0 lh-1" th:text="${totalAllowances}"></p>
                                <span class="tx-11 tx-roboto tx-white-8"></span>
                            </div>
                        </div>
                        <div id="ch1" class="ht-50 tr-y-1"></div>
                    </div>
                </div><!-- col-3 -->
         <div class="col-md-4 mb-3">
                    <div class="bg-purple rounded overflow-hidden">
                        <div class="pd-x-20 pd-t-20 d-flex align-items-center">
                            <i class="ion ion-bag tx-60 lh-0 tx-white op-7"></i>
                            <div class="mg-l-20">
                                <p class="tx-10 tx-spacing-1 tx-mont tx-semibold tx-uppercase tx-white-8 mg-b-10">Total 
                                   Deduction</p>
<p class="tx-24 tx-white tx-lato tx-bold mg-b-0 lh-1" 
   th:text="${session.totalexpense == null ? '₹0' : '₹' + totalDeductions}"></p>
                                <span class="tx-11 tx-roboto tx-white-8"></span>
                            </div>
                        </div>
                        <div id="ch3" class="ht-50 tr-y-1"></div>
                    </div>
                </div><!-- col-3 -->
                </div>
           

			<!-- Filter Form -->
			<div class="container">
				<div class="row">
					<!-- Generate Salary Form -->
					<div class="col-md-5">
						<form th:action="@{/admin/payroll/generate}" method="get"
							class="mb-4" id="filterForm">
							<div class="row ">
								<div class="col-md-5">
									<label>Month:</label> <select name="month" class="form-control">
										<option
											th:value="${#dates.format(#dates.createNow(), 'MMMM')}"
											th:text="'Current (' + ${#dates.format(#dates.createNow(), 'MMMM')} + ')'"
											selected></option>
										<option value="January">January</option>
										<option value="February">February</option>
										<option value="March">March</option>
										<option value="April">April</option>
										<option value="May">May</option>
										<option value="June">June</option>
										<option value="July">July</option>
										<option value="August">August</option>
										<option value="September">September</option>
										<option value="October">October</option>
										<option value="November">November</option>
										<option value="December">December</option>
									</select>
								</div>

								<div class="col-md-5">
									<label>Year:</label> <select name="year" class="form-control">
										<option
											th:value="${#dates.format(#dates.createNow(), 'yyyy')}"
											th:text="'Current (' + ${#dates.format(#dates.createNow(), 'yyyy')} + ')'"
											selected></option>
										<option th:each="y : ${#numbers.sequence(2020, 2030)}"
											th:value="${y}" th:text="${y}"></option>
									</select>
								</div>

								<div class="col-sm d-flex  mt-3">
									<button type="submit" class="btn btn-primary">Generate
										Salary</button>
								</div>
							</div>
						</form>
					</div>

					<!-- Lock Salary Form -->
					<div class="col-md-5 ">
						<form th:action="@{/admin/payroll/lock}" method="get" class="mb-4"
							id="filterForm">
							<div class="row g-3">
								<div class="col-md-5">
									<label>Month:</label> <select name="month" class="form-control">
										<option
											th:value="${#dates.format(#dates.createNow(), 'MMMM')}"
											th:text="'Current (' + ${#dates.format(#dates.createNow(), 'MMMM')} + ')'"
											selected></option>
										<option value="January">January</option>
										<option value="February">February</option>
										<option value="March">March</option>
										<option value="April">April</option>
										<option value="May">May</option>
										<option value="June">June</option>
										<option value="July">July</option>
										<option value="August">August</option>
										<option value="September">September</option>
										<option value="October">October</option>
										<option value="November">November</option>
										<option value="December">December</option>
									</select>
								</div>

								<div class="col-md-5">
									<label>Year:</label> <select name="year" class="form-control">
										<option
											th:value="${#dates.format(#dates.createNow(), 'yyyy')}"
											th:text="'Current (' + ${#dates.format(#dates.createNow(), 'yyyy')} + ')'"
											selected></option>
										<option th:each="y : ${#numbers.sequence(2020, 2030)}"
											th:value="${y}" th:text="${y}"></option>
									</select>
								</div>

								<div class="col-sm d-flex  mt-3">
									<button type="submit" class="btn btn-danger">Lock
										Salary</button>
								</div>
							</div>
						</form>
					</div>
					<div class="col-md-6">
						<form th:action="@{/admin/payroll}" method="get" class="mb-4"
							id="filterForm">
							<div class="row">

								<div class="col-md-4">
									<label>Month:</label> <select name="month" class="form-control">
										<!-- Current Month Option -->
											<option value="ALL" selected>All</option>

										<!-- Static Month Options -->
										<option value="January">January</option>
										<option value="February">February</option>
										<option value="March">March</option>
										<option value="April">April</option>
										<option value="May">May</option>
										<option value="June">June</option>
										<option value="July">July</option>
										<option value="August">August</option>
										<option value="September">September</option>
										<option value="October">October</option>
										<option value="November">November</option>
										<option value="December">December</option>
									</select>
								</div>

								<div class="col-md-4">
									<label>Year :</label> <select name="year" class="form-control">
										<option
											th:value="${#dates.format(#dates.createNow(), 'yyyy')}"
											th:text="${#dates.format(#dates.createNow(), 'yyyy')} "
											selected></option>
										<option th:each="y : ${#numbers.sequence(2020, 2030)}"
											th:value="${y}" th:text="${y}"></option>
									</select>
								</div>







								<div class="col-12  mt-3">
									<button type="submit" class="btn btn-primary">Search
										Salary</button>

								</div>

							</div>


						</form>

					</div>

				</div>
			</div>



			<nav aria-label="navigation "
				class="mb-0 table d-flex justify-content-end">
				<ul class="pagination d-flex flex-wrap">
					<!-- Previous Page -->
					<li class="page-item"
						th:classappend="${currentPage == 0} ? 'disabled'"><a
						class=" btn btn-info btn-primary " th:if="${currentPage > 0}"
						th:href="@{/admin/payroll(page=${currentPage - 1}, size=${size}, 
                                   year=${selectedYear}, 
                                  month=${selectedMonth})}">
							<span class="d-flex align-items-center"> <i
								class="fa-solid fa-arrow-left"></i>&nbsp; Back
						</span>
					</a></li>

					<!-- Next Page -->
					<li class="page-item "
						th:classappend="${currentPage + 1 == totalPages} ? 'disabled'">
						<a class="btn btn-info btn-primary mg-l-10"
						th:if="${currentPage !=totalPages-1}"
						th:href="@{/admin/payroll(page=${currentPage + 1}, size=${size}, 
                                   year=${selectedYear}, 
                                  month=${selectedMonth})}">
							<span> Next&nbsp<i class="fa-solid fa-arrow-right"></i>
						</span>
					</a>

					</li>
				</ul>
			</nav>
			

			<div class="br-section-wrapper pd-20">


				<!-- Expense Table -->
				<div class="table-responsive">
    <table id="datatable1" class="table display responsive table-striped nowrap">
        <thead>
            <tr>
                <th class="col-1">#</th>
                <th class="col-2">Employee Id</th>
                <th class="col-2">Employee Name</th>
                <th class="col-2">Total Allowances</th>
                <th class="col-2">Total Deductions</th>
                <th class="col-2">Net Salary</th>
                <th class="col-2">Month</th>
                <th class="col-2">Year</th>
                <th class="wd-2">Generate Payslip</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="fund, stat : ${payrolls}">
                <td th:text="${stat.index + 1 + ((currentPage != null ? currentPage : 0) * (size != null ? size : 10))}"></td>
                <td th:text="${fund.employeeId}"></td>
                <td th:text="${fund.employeeName}"></td>
                <td th:text="${fund.totalAllowance}"></td>
                <td class="d-flex ">
                    <a th:href="@{/admin/add-deduction(id=${fund.employeeId} ,month=${fund.month},year=${fund.year})}"
                        class="btn btn-primary btn-sm mg-x-4 ">
                        <i class="fas fa-minus"></i> <span th:text="${fund.totalDeduction}"></span>
                    </a>
                    <form  th:action="@{/admin/delete-deduction(id=${fund.employeeId}, month=${fund.month}, year=${fund.year})}"
      method="post" th:id="'delete-deduction-' + ${fund.employeeId} + '-' + ${fund.month} + '-' + ${fund.year}">
    <input type="hidden" name="_method" value="delete">
    <button type="button" class="btn btn-danger delete-btn btn-sm"
            th:attr="data-id=${fund.employeeId}, data-month=${fund.month}, data-year=${fund.year}">
        <i class="fas fa-trash"></i>
    </button>
</form>

                                    </td>
                <td th:text="${fund.netSalary}"></td>
                <td th:text="${fund.month}"></td>
                <td th:text="${fund.year}"></td>
                <td>
                    <a th:href="@{/admin/generate/payslip(id=${fund.employeeId}, month=${fund.month}, year=${fund.year})}"
                        class="btn btn-primary btn-sm" target="_blank">
                        <i class="fa-solid fa-money-bill-wave"></i>
                    </a>
                </td>
            </tr>
        </tbody>

        <!-- Footer for Total Allowance -->
        <tfoot>
            <tr>
                <td colspan="3" class="text-end fw-bold">Total:</td>
                <td class="fw-bold" th:text="${totalAllowances}"></td> <!-- Display total here -->
                 <td class="fw-bold" th:text="${totalDeductions}"></td> 
                <td colspan="4"></td>
            </tr>
        </tfoot>
    </table>
</div>

				<nav aria-label="navigation "
					class="mb-0 table d-flex justify-content-end">
					<ul class="pagination d-flex flex-wrap">
						<!-- Previous Page -->
						<li class="page-item"
							th:classappend="${currentPage == 0} ? 'disabled'"><a
							class=" btn btn-info btn-primary " th:if="${currentPage > 0}"
							th:href="@{/admin/payroll(page=${currentPage - 1}, size=${size}, 
                                   year=${selectedYear}, 
                                  month=${selectedMonth})}">
								<span class="d-flex align-items-center"> <i
									class="fa-solid fa-arrow-left"></i>&nbsp; Back
							</span>
						</a></li>


						<!-- Next Page -->
						<li class="page-item "
							th:classappend="${currentPage + 1 == totalPages} ? 'disabled'">
							<a class="btn btn-info btn-primary mg-l-10"
							th:if="${currentPage !=totalPages-1}"
							th:href="@{/admin/payroll(page=${currentPage + 1}, size=${size}, 
                                   year=${selectedYear}, 
                                  month=${selectedMonth})}">
								<span> Next&nbsp<i class="fa-solid fa-arrow-right"></i>
							</span>
						</a>

						</li>
					</ul>
				</nav>
				</div>
			</div>
		
		<th:block th:insert="admin/admin-dashboard :: footer"></th:block>
	</div>



	<div th:if="${success}">
		<script th:inline="javascript">
			document.addEventListener("DOMContentLoaded", function() {
				$.SweetAlert.showSuccess(/*[[${success}]]*/);
			});
		</script>
	</div>
	<div th:if="${error}">
		<script th:inline="javascript">
			document.addEventListener("DOMContentLoaded", function() {
				$.SweetAlert.showError(/*[[${error}]]*/);
			});
		</script>

	</div>




	<!-- Delete Confirmation -->
	<!-- 	<script>
        function addDeduction(event) {
            event.preventDefault();
            Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    event.target.closest("form").submit();
                }
            });
        }

        /* document.addEventListener("DOMContentLoaded", function () {
            let today = new Date().toISOString().split("T")[0];
            document.getElementById("fromDate").setAttribute("max", today);
            document.getElementById("toDate").setAttribute("max", today);
        }); */
    </script> -->
    	<script>
    	document.addEventListener("DOMContentLoaded", function () {
    	    document.querySelectorAll(".delete-btn").forEach(button => {
    	        button.addEventListener("click", function (event) {
    	            event.preventDefault();
    	            
    	            let employeeId = this.getAttribute("data-id");
    	            let month = this.getAttribute("data-month");
    	            let year = this.getAttribute("data-year");

    	            Swal.fire({
    	                title: "Are you sure?",
    	                text: "You won't be able to revert this!",
    	                icon: "warning",
    	                showCancelButton: true,
    	                confirmButtonColor: "#3085d6",
    	                cancelButtonColor: "#d33",
    	                confirmButtonText: "Yes, delete it!"
    	            }).then((result) => {
    	                if (result.isConfirmed) {
    	                    let formId = `delete-deduction-${employeeId}-${month}-${year}`; // ✅ Match form ID
    	                    document.getElementById(formId).submit(); // ✅ Submit correct form
    	                }
    	            });
    	        });
    	    });
    	});

</script>
	<script>
		$(function() {
			'use strict';

			$('#datatable1').DataTable({
				responsive : false,
				language : {
					searchPlaceholder : 'Search...',
					sSearch : '',
					lengthMenu : false,
				}
			});

			$('#datatable2').DataTable({
				bLengthChange : false,
				searching : false,
				responsive : true
			});

			// Select2
			$('.dataTables_length select').select2({
				minimumResultsForSearch : Infinity
			});
		});
	</script>
</body>
</html>
